---
title: "R Notebook"
---


```{r}
library(tidyverse)
library(gggroupedscale)
source("utils.R")
source("annotation_helper.R")
```

Load data

```{r}
res <- bind_rows(
  read_tsv("../benchmark/output/benchmark_results/simulation_results.tsv") %>% 
    transmute(benchmark = "simulation", overlap = mean_knn_overlap, knn, pca_dim, alpha = as.character(alpha), transformation, dataset = simulator, replicate = seed, duration_sec),
  read_tsv("../benchmark/output/benchmark_results/consistency_results.tsv") %>% 
    transmute(benchmark = "consistency", overlap = mean_overlap, knn, pca_dim, alpha = as.character(alpha), transformation, dataset, replicate = seed, duration_sec),
  read_tsv("../benchmark/output/benchmark_results/downsampling_results.tsv") %>% 
    transmute(benchmark = "downsampling", overlap = overlap, knn, pca_dim, alpha = as.character(alpha), transformation, dataset, replicate = seed, duration_sec = duration_full_sec)
) %>%
  mutate(transformation = factor(transformation, levels = trans_families$transformation))
res
```

Define which parameters are shown for which dataset
```{r}
parameter_choices <- bind_rows(
  tibble(benchmark = "downsampling", knn = 50, pca_dim = c(10, 10, 10, 10, 50),
         dataset = c("mcSCRB", "smartSeq3_fibroblasts", "smartSeq3_fibroblasts_alt", "smartSeq3_hek", "smartSeq3_siRNA_knockdown")),
  tibble(benchmark = "simulation", knn = 50, pca_dim = c(5, 10, 10, 200, 50),
         dataset = c("dyngen", "linear_walk", "muscat", "random_walk", "scDesign2")),
  tibble(benchmark = "consistency", knn = 50, pca_dim = 50,
         dataset = unique(filter(res, benchmark == "consistency")$dataset)),
)
```

```{r}
print(paste0(sum(res$duration_sec) / (60 * 60 * 24 * 356), " years total compute time"))
```


# Headline plot

Make the main benchmark overview panels
```{r}
res_main <- res %>%
  filter(alpha %in% c("TRUE", "FALSE")) %>%
  tidylog::inner_join(parameter_choices)  %>%
  mutate(knn_recovery = overlap / knn) %>%
  group_by(dataset, replicate, knn) %>%
  mutate(knn_recovery = knn_recovery / mean(knn_recovery)) %>%
  tidylog::left_join(trans_families)

make_main_plot_panel <- function(data, add_group_label = FALSE){
  ggplot(data, aes(x = transformation, y = knn_recovery, color = family)) +
    geom_hline(yintercept = 1, size = 0.3, linetype = 2) +
    ggbeeswarm::geom_quasirandom(color = "grey", size = 0.3, alpha = 0.3) +
    stat_summary(geom = "pointrange", position = position_dodge2(width = 0.3), fun.data = mean_cl_boot, fatten = 1.8) +
    scale_x_grouped_discrete(grouping = ~ trans_families_labels[deframe(trans_families)[.x]], gap_size = 1.5, 
                             labels = trans_labels, add_group_label = add_group_label, guide = if(add_group_label) guide_grouped_axis(angle = 90) else guide_axis(angle = 90)) +
    scale_y_continuous(limits = c(0.2, 1.8), breaks = c(0.5, 1, 1.5)) +
    scale_color_manual(values = trans_families_colors, labels = trans_families_labels, guide = "none") +
    theme_grouped_axis(axis.grouping.line_padding = unit(5, "pt"), axis.grouping.line_height = unit(10, "pt")) +
    theme(axis.title.x = element_blank(),  plot.title.position = "plot")
}

consistency_pl <- res_main %>%
  filter(benchmark == "consistency") %>%
  make_main_plot_panel(add_group_label = FALSE) +
  labs(y = "Relative KNN\nOverlap", 
       title = "(A) Consistency: 10X gene subset A vs. gene subset B") +
  NULL

simulation_pl <- res_main %>%
  filter(benchmark == "simulation") %>%
  make_main_plot_panel(add_group_label = FALSE) +
  labs(y = "Relative KNN\nOverlap", 
       title = "(B) Simulation: Ground truth vs. simulated counts") +
  NULL


downsampling_pl <- res_main %>%
  filter(benchmark == "downsampling") %>%
  make_main_plot_panel(add_group_label = TRUE) +
  labs(y = "Relative KNN\nOverlap", 
       title = "(C) Downsampling: Original vs. downsampled Smart-seq3 data") +
  NULL

```


Make the same panels but with $k=10$ and $k=100$
```{r}
res_alt_knn <- res %>%
  filter(alpha %in% c("TRUE", "FALSE")) %>%
  tidylog::inner_join(dplyr::select(parameter_choices, -knn))  %>%
  filter(knn != parameter_choices$knn[1]) %>%
  mutate(knn_recovery = overlap / knn) %>%
  group_by(dataset, replicate, knn) %>%
  mutate(knn_recovery = knn_recovery / mean(knn_recovery)) %>%
  tidylog::left_join(trans_families)

suppl_con_k10 <- res_alt_knn %>%
  filter(knn == 10) %>%
  filter(benchmark == "consistency") %>%
  make_main_plot_panel(add_group_label = FALSE) +
  labs(y = "Relative KNN\nOverlap", 
       title = "(A) Consistency: k = 10") +
  NULL

suppl_con_k100 <- res_alt_knn %>%
  filter(knn == 100) %>%
  filter(benchmark == "consistency") %>%
  make_main_plot_panel(add_group_label = FALSE) +
  labs(y = "Relative KNN\nOverlap", 
       title = "(B) Consistency: k = 100") +
  NULL

suppl_sim_k10 <- res_alt_knn %>%
  filter(knn == 10) %>%
  filter(benchmark == "simulation") %>%
  make_main_plot_panel(add_group_label = FALSE) +
  labs(y = "Relative KNN\nOverlap", 
       title = "(C) Simulation: k = 10") +
  NULL

suppl_sim_k100 <- res_alt_knn %>%
  filter(knn == 100) %>%
  filter(benchmark == "simulation") %>%
  make_main_plot_panel(add_group_label = FALSE) +
  labs(y = "Relative KNN\nOverlap", 
       title = "(D) Simulation: k = 100") +
  NULL


suppl_dow_k10 <- res_alt_knn %>%
  filter(knn == 10) %>%
  filter(benchmark == "downsampling") %>%
  make_main_plot_panel(add_group_label = TRUE) +
  labs(y = "Relative KNN\nOverlap", 
       title = "(E) Downsampling: k = 10") +
  NULL

suppl_dow_k100 <- res_alt_knn %>%
  filter(knn == 100) %>%
  filter(benchmark == "downsampling") %>%
  make_main_plot_panel(add_group_label = TRUE) +
  labs(y = "Relative KNN\nOverlap", 
       title = "(F) Downsampling: k = 100") +
  NULL

plot_assemble(list(plot = suppl_con_k10,    x = 0,  y = 0,    width = 88, height = 50),
              list(plot = suppl_con_k100,   x = 92, y = 0,    width = 88, height = 50),
              list(plot = suppl_sim_k10,    x = 0,  y = 50,   width = 88, height = 50),
              list(plot = suppl_sim_k100,   x = 92, y = 50,   width = 88, height = 50),
              list(plot = suppl_dow_k10,    x = 0,  y = 100,  width = 88, height = 55),
              list(plot = suppl_dow_k100,   x = 92, y = 100,  width = 88, height = 55),
              width = 180, height = 155, units = "mm", show_grid_lines = FALSE,
              filename = "../output/suppl_alt_k_benchmark.pdf", latex_support = TRUE)

```


```{r}
res_full_bench <- res %>%
  filter(alpha %in% c("TRUE", "FALSE")) %>%
  tidylog::inner_join(parameter_choices)  %>%
  tidylog::left_join(trans_families)

make_main_suppl_plot_panels <- function(data, add_group_label = FALSE){
  ggplot(data, aes(x = transformation, y = overlap, color = family)) +
    geom_hline(data = . %>% group_by(dataset) %>% summarize(mean = mean(overlap)), aes(yintercept = mean), size = 0.3, linetype = 2) +
    ggbeeswarm::geom_quasirandom(color = "grey", size = 0.3, alpha = 0.8) +
    stat_summary(geom = "pointrange", position = position_dodge2(width = 0.3), fun.data = mean_cl_boot, fatten = 1.8) +
    scale_x_grouped_discrete(grouping = ~ trans_families_labels[deframe(trans_families)[.x]], gap_size = 1.5,
                             labels = trans_labels, add_group_label = add_group_label, guide = if(add_group_label) guide_grouped_axis(angle = 90) else guide_axis(angle = 90)) +
    scale_y_continuous(limits = c(0, NA), expand = expansion(mult = c(0, 0.2))) +
    scale_color_manual(values = trans_families_colors, labels = trans_families_labels, guide = "none") +
    facet_wrap(vars(dataset), ncol = 3, scales = "free_y", labeller = labeller(dataset = dataset_labels)) +
    theme_grouped_axis(axis.grouping.line_padding = unit(5, "pt"), axis.grouping.line_height = unit(10, "pt"), axis.grouping.label.x = element_text(size = font_size_small)) +
    theme(axis.title.x = element_blank(),  plot.title.position = "plot", axis.text.x = element_text(size = font_size_tiny), strip.background = element_blank()) 
}

con_suppl_pl <- res_full_bench %>%
  filter(benchmark == "consistency") %>%
  make_main_suppl_plot_panels(add_group_label = FALSE) +
  labs(title = "(A) Consistency: 10X gene subset A vs. gene subset B")

sim_suppl_pl <- res_full_bench %>%
  filter(benchmark == "simulation") %>%
  make_main_suppl_plot_panels(add_group_label = FALSE) +
  labs(title = "(B) Simulation: Ground truth vs. simulated counts")

dow_suppl_pl <- res_full_bench %>%
  filter(benchmark == "downsampling") %>%
  make_main_suppl_plot_panels(add_group_label = TRUE) +
  labs(title = "(C) Downsampling: Original vs. downsampled Smart-seq3 data")

plot_assemble(
  list(plot = con_suppl_pl, x = 0, y = 0, width = 180, height = 90),
  list(plot = sim_suppl_pl, x = 0, y = 90, width = 180, height = 60),
  list(plot = dow_suppl_pl, x = 0, y = 150, width = 180, height = 65),
  width = 180, height = 215, units = "mm", show_grid_lines = FALSE,
  filename = "../output/suppl-raw_benchmark_results.pdf", latex_support = TRUE
)

```


# Number of PCA dimensions are important

```{r}
pca_dat <- res %>%
  filter(alpha %in% c("TRUE", "FALSE")) %>%
  filter(knn == 50) %>%
  mutate(knn_recovery = overlap / knn) %>%
  tidylog::group_by(benchmark, dataset, pca_dim, transformation) %>%
  tidylog::summarize(knn_recovery = mean(knn_recovery), .groups = "drop") %>%
  tidylog::left_join(trans_families) %>%
  mutate(transformation = fct_reorder(transformation, runif(n()))) %>%
  mutate(is_dim_indep = transformation == "sanity_dists")


make_pca_plot_panel <- function(data, long_x_scale, breaks = c(0)){
  ggplot(data, aes(x = pca_dim, y = knn_recovery)) +
    geom_line(aes(group = transformation, color = family, linetype = is_dim_indep), size = 0.4, show.legend = FALSE) +
    (if(long_x_scale) scale_x_log10(breaks = c(10, 100, 1000, 1e5), labels = expression(10^1, 10^2, 10^3, "all")) 
     else scale_x_log10(breaks = c(5, 10, 50, 100))) +
    scale_color_manual(values = trans_families_colors) +
    scale_y_continuous(limits = c(0, NA), breaks = breaks) +
    scale_linetype_manual(values = c(`TRUE` = "dashed", `FALSE`  = "solid")) +
    labs(y = "KNN Overlap", x = "\\#PCA-dimensions")
}

pca_pl_random_walk <- pca_dat %>%
  filter(dataset == "random_walk") %>%
  make_pca_plot_panel(long_x_scale = TRUE, breaks = c(0, 0.4, 0.8)) +
  theme(axis.title.x = element_blank())


pca_pl_scDesign2 <- pca_dat %>%
  filter(dataset == "scDesign2") %>%
  make_pca_plot_panel(long_x_scale = TRUE, breaks = c(0, 0.1, 0.2))

pca_pl_siRNA_kd <- pca_dat %>%
  filter(dataset == "smartSeq3_siRNA_knockdown") %>%
  make_pca_plot_panel(long_x_scale = FALSE, breaks = c(0, 0.1)) +
  theme(axis.title.x = element_blank())


pca_pl_10X <- pca_dat %>%
  filter(dataset == "GSE179714") %>%
  make_pca_plot_panel(long_x_scale = FALSE, breaks = c(0, 0.2, 0.4, 0.6))

```

# Duration plots

```{r}
sel_dataset <- "GSE179831" 
rel_scaling_factor_lin <- median(filter(res, transformation == "logp1", dataset == sel_dataset, pca_dim == 10)$duration_sec)

perf_plot <- res %>%
  filter(alpha %in% c("TRUE", "FALSE")) %>%
  filter(dataset == sel_dataset, pca_dim == 10) %>%
  tidylog::left_join(trans_families) %>%
  ggplot(aes(x = transformation, y = duration_sec)) +
    geom_hline(yintercept = rel_scaling_factor_lin, linetype = 2, color = "grey", size = 0.3) +
    geom_hline(yintercept = rel_scaling_factor_lin * c(10, 100, 1000, 10000), linetype = 2, color = "grey", size = 0.1) +
    stat_summary(geom = "pointrange", aes(color = family), position = position_dodge2(width = 0.3), fun.data = mean_sdl, fatten = 1.8) +
    geom_text(data = data.frame(y = 10^seq(0, 4)), aes(y = rel_scaling_factor_lin * y, label = paste0("$", y, "\\times$")),
              x = 23.5, hjust = 1, vjust = -0.3, size = font_size_small / .pt) +
    scale_x_grouped_discrete(grouping = ~ trans_families_labels[deframe(trans_families)[.x]], gap_size = 1.5, 
                             labels = trans_labels, add_group_label = TRUE, guide =  guide_grouped_axis(angle = 90)) +
    scale_y_log10(breaks = c(0.001, 1, 60, 60 * 60, 24 * 60 * 60, 7 * 24 * 60 * 60), expand = expansion(mult = c(0.1, 0.01)),
        labels = c("1 ms", "1 sec", "1 min", "1 hour", "1 day", "1 week"), name = "",
        sec.axis = sec_axis(trans = ~ .x / rel_scaling_factor_lin, breaks = c(1, 10, 100, 1000, 10000))) +
    coord_cartesian(clip = "off") +
    scale_color_manual(values = trans_families_colors, guide = "none") +
    theme_grouped_axis(axis.grouping.line_padding = unit(5, "pt"), axis.grouping.line_height = unit(10, "pt")) +
    theme(axis.title.x = element_blank(), axis.text.y.right = element_blank(), axis.ticks.y.right = element_blank(), plot.title.position = "plot") +
    labs(title = "(E) Duration for transformation + KNN calculation", y = "")
  

perf_plot

```



```{r}
dataset_summaries <- read_tsv("../benchmark/output/benchmark_results/dataset_summaries.tsv") %>%
  dplyr::rename(dataset = name)
```

```{r}
res %>%
  filter(alpha %in% c("TRUE", "FALSE")) %>%
  filter(pca_dim == 10) %>%
  left_join(trans_families) %>%
  left_join(dataset_summaries %>% dplyr::select(-c(row_means, row_vars))) %>%
  mutate(highlight = case_when(
    transformation == "sanity_dists" ~ "sanity_dist",
    transformation == "sanity_map" ~ "sanity_map",
    transformation == "logp1_hvg" ~ "logp1_hvg",
    transformation == "pearson_analytic" ~ "pearson_analytic",
    transformation == "dino" ~ "dino",
    TRUE ~ "other"
  )) %>%
  ggplot(aes(x = n_cells, y = duration_sec)) +
    geom_point() +
    geom_line(aes(color = family, group = transformation)) +
    scale_x_log10() +
    scale_y_log10()
```



```{r}
time_minor_ticks <- tibble(ticks = c(seq(0, 60, by = 10), # seconds
                                     seq(0, 60 * 60, by = 10 * 60), # 10 minutes
                                     seq(0, 24 * 60 * 60, by = 6 * 60 * 60),  # 6 hours
                                     seq(0, 7 * 24 * 60 * 60, by = 24 * 60 * 60), # 1 day
                                     seq(0, 8* 7 * 24 * 60 * 60, by = 5 * 24 * 60 * 60))) # 4 weeks
time_major_ticks <- tibble(ticks = c(1, 60, 60 * 60, 24 * 60 * 60, 7 * 24 * 60 * 60))

res %>%
  filter(alpha %in% c("TRUE", "FALSE")) %>%
  filter(pca_dim == 10) %>%
  left_join(trans_families) %>%
  left_join(dataset_summaries %>% dplyr::select(-c(row_means, row_vars))) %>%
  mutate(highlight = case_when(
    transformation == "sanity_dists" ~ "sanity_dist",
    transformation == "sanity_map" ~ "sanity_map",
    transformation == "logp1_hvg" ~ "logp1_hvg",
    transformation == "pearson_analytic" ~ "pearson_analytic",
    transformation == "dino" ~ "dino",
    TRUE ~ "other"
  )) %>%
  ggplot(aes(x = n_cells, y = duration_sec)) +
    ggrastr::rasterise(ggbeeswarm::geom_quasirandom(alpha = 0.1, color = "#E1E1E1", size = 0.1), dpi = 300) +
    geom_smooth(aes(group = transformation, color = highlight), method = "lm", size = 0.6, se = FALSE) +
    geom_rug(data = time_minor_ticks, aes(y = ticks, x = 0), sides = "l", color = "black", length = unit(0.3, "mm")) +
    geom_rug(data = time_major_ticks, aes(y = ticks, x = 0), sides = "l", color = "black", length = unit(0.5, "mm")) +
    annotation_logticks(sides = "b", short = unit(0.3, "mm"), mid = unit(0.3, "mm"), long = unit(0.5, "mm")) +
    scale_y_log10(breaks = c(0.001, 1, 60, 60 * 60, 24 * 60 * 60, 7 * 24 * 60 * 60),
        labels = c("1ms", "1sec", "1min", "1hour", "1day", "1week"), name = "", limits = c(1, NA), expand = expansion(mult = 0.01, 0.05)) +
    scale_x_log10(breaks = c(300, 1000, 3000, 1e4, 3e4)) +
    # scale_color_manual(values = transformation_category_colors, labels = transformation_category_pretty, guide = "none") +
    labs(title = "(F) The computation time depends on \\#cells", x = "\\#Cells") +
    theme(plot.title.position = "plot")

scaling_plot <- res %>%
  filter(alpha %in% c("TRUE", "FALSE")) %>%
  filter(pca_dim == 10) %>%
  left_join(trans_families) %>%
  left_join(dataset_summaries %>% dplyr::select(-c(row_means, row_vars))) %>%
  ggplot(aes(x = n_cells, y = duration_sec)) +
    ggrastr::rasterise(ggbeeswarm::geom_quasirandom(alpha = 0.1, color = "#E1E1E1", size = 0.1), dpi = 300) +
    geom_smooth(aes(group = transformation, color = family), method = "lm", size = 0.6, se = FALSE) +
    geom_rug(data = time_minor_ticks, aes(y = ticks, x = 0), sides = "l", color = "black", length = unit(0.3, "mm")) +
    geom_rug(data = time_major_ticks, aes(y = ticks, x = 0), sides = "l", color = "black", length = unit(0.5, "mm")) +
    annotation_logticks(sides = "b", short = unit(0.3, "mm"), mid = unit(0.3, "mm"), long = unit(0.5, "mm")) +
    scale_y_log10(breaks = c(0.001, 1, 60, 60 * 60, 24 * 60 * 60, 7 * 24 * 60 * 60),
        labels = c("1ms", "1sec", "1min", "1hour", "1day", "1week"), name = "", limits = c(1, NA), expand = expansion(mult = 0.01, 0.05)) +
    scale_x_log10(breaks = c(300, 1000, 3000, 1e4, 3e4)) +
    scale_color_manual(values = trans_families_colors, guide = "none") +
    labs(title = "(F) The computation time depends on \\#cells", x = "\\#Cells") +
    theme(plot.title.position = "plot")

scaling_plot
```


```{r fig.height=3.71, fig.width=6.69, dev="ragg_png"}
perf_box <-  grid::rectGrob(x = 0, y = 0, width = 87, height = 94, default.units = "mm", gp = grid::gpar(fill = "transparent", col = "lightgrey", lty = 5), hjust = 0, vjust = 1)

plot_assemble(list(plot = consistency_pl,     x = 0,  y = 0,    width = 88, height = 50),
              list(plot = simulation_pl,      x = 92, y = 0,    width = 88, height = 50),
              list(plot = downsampling_pl,    x = 0,  y = 50,   width = 88, height = 55),
              list(plot = perf_plot,          x = 92, y = 50,   width = 88, height = 55),
              annotate_text("(D) KNN overlap depends on \\#PCA-dimensions", x = 2, y = 109, fontsize = font_size, fontface = "bold"),
              list(plot = pca_pl_random_walk, x = 0,  y = 111,  width = 44, height = 17.5),
              list(plot = pca_pl_scDesign2,   x = 0,  y = 126,  width = 44, height = 19),
              list(plot = pca_pl_siRNA_kd,    x = 45, y = 111,  width = 44, height = 17.5),
              list(plot = pca_pl_10X,         x = 45, y = 126,  width = 44, height = 19),
              list(plot = scaling_plot,       x = 92, y = 105,  width = 72, height = 40),
              annotate_text("Sanity Distance", fontsize = font_size_small, x = 160.5, y = 112.5),
              annotate_text("Sanity MAP", fontsize = font_size_small, x = 160.5, y = 117),
              annotate_text("Dino", fontsize = font_size_small, x = 160.5, y = 120),
              annotate_text("...", fontsize = font_size_small, x = 162, y = 126, angle = 90),
              annotate_text(r"($\log(x/s+1)\rightarrow\textrm{HVG}$)", fontsize = font_size_small * 0.9, x = 160.5, y = 130),
              list(plot = perf_box, x = 92, y = 50, width = 0, height = 0),
              width = 180, height = 145, units = "mm", show_grid_lines = FALSE,
              filename = "../output/main_benchmark_fig.pdf", latex_support = TRUE)
```



# Session Info

```{r}
sessionInfo()
```

